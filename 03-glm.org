#+TITLE: Stata : modélisation statistique
#+LANGUAGE: fr
#+HTML_HEAD: <link rel="stylesheet" type="text/css" href="worg.css" />
#+HTML_MATHJAX: scale: 90
#+OPTIONS: H:3 num:nil toc:t \n:nil ':t @:t ::t |:t ^:nil -:t f:t *:t TeX:t skip:nil d:nil html-style:nil html-postamble:nil tags:not-in-toc

Dans cet exposé, on s'intéressera à la construction de modèles de régression explicatifs ou prédictifs.

Il existe un très bon ouvrage traitant du modèle linéaire généralisé, à présent dans sa quatrième édition et publié chez Stata Press : [[https://www.stata.com/bookstore/generalized-linear-models-and-extensions/][Generalized Linear Models and Extensions]] de Hardin & Hilbe.

La mise en oeuvre d'un modèle de régression a déjà été discutée brièvement dans le [[./00-intro.html][tutoriel d'introduction à Stata]]. Dans ce chapitre, on va s'intéresser à l'estimation des paramètres d'un modèle de régression, à la sélection de modèle dans un cadre explicatif, au diagnostic du modèle, et à la prédiction ponctuelle ou par intervalles. On prendra pour base des données observationnelles issues d'enquêtes ou d'études cliniques transversales. Les séries chronologiques et les données longitudinales seront traitées dans des chapitres séparés.

* Le modèle de régression linéaire simple

Dans un premier temps, procédons à quelques rappels concernant la régression linéaire simple, la corrélation linéaire et le test de Student. Les notions connexes telles que les associations non linéaires ou les approches non paramétriques seront traitées ultérieurement. 

** Un exemple de régression linéaire simple

Les données d'illustration peuvent être chargées directement depuis internet à l'aide de la commande [[stata:webuse][webuse]]. Il s'agit d'une enquête épidémiologique rétrospective dans laquelle on s'intéresse aux facteurs de risque d'un bébé ayant un poids inférieur à la norme, selon les normes américaines des années 90. Ces données sont extensivement analysées dans l'ouvrage de Hosmer & Lemeshow cite:hosmer-2000-applied-logis-regres. Au total, le tableau de données contient 11 variables, la variable réponse étant le poids des bébés (=bwt=) :

#+BEGIN_SRC stata :session :results output :exports both
webuse lbw
describe, simple
#+END_SRC

#+RESULTS:
: set more off
: webuse lbw
: (Hosmer & Lemeshow data)
: describe, simple
: id     low    age    lwt    race   smoke  ptl    ht     ui     ftv    bwt

La relation entre le poids des bébés (en grammes) et le poids des mères (initialement en livres, converti en kilogrammes) est représentée dans la figure suivante sous la forme d'un simple diagramme de dispersion. Pour faciliter la lecture, le poids des mères est converti en kilogrammes, sans modifier le mode de représentation de la variable :

#+BEGIN_SRC stata :session :results output :exports both
replace lwt = lwt / 2.204623, nopromote
#+END_SRC

Ensuite, on utilise la commande [[stata:scatter][scatter]] pour construire le diagramme de dispersion :

#+BEGIN_SRC stata :session :results output :exports code
set scheme plotplain
graph twoway scatter bwt lwt
graph export "fig-03-scatter-bwt-lwt.pdf", fontface(DroidSans) replace
#+END_SRC

#+CAPTION:   Relation entre le poids des bébés et le poids des mères
#+NAME:      fig:03-scatter-bwt-lwt
#+LABEL:     fig:03-scatter-bwt-lwt
#+ATTR_HTML: :width 640px
#+ATTR_ORG:  :width 100
[[./fig-03-scatter-bwt-lwt.png]]

Il est tout à fait possible et largement recommendé de superposer une courbe loess cite:cleveland-1979-robus-local sur le diagramme de dispersion précédent afin d'évaluer visuellement les écarts à la linéarité concernant la relation entre ces deux variables. La commande [[stata:lowess][lowess]] peut être combinée à [[stata:scatter][scatter]] :

#+BEGIN_SRC stata :session :results output :exports code
graph twoway scatter bwt lwt || lowess bwt lwt, legend(off)
graph export "fig-03-lowess-bwt-lwt.pdf", fontface(DroidSans) replace
#+END_SRC

#+CAPTION:   Relation entre le poids des bébés et le poids des mères (courbe loess)
#+NAME:      fig:03-lowess-bwt-lwt
#+LABEL:     fig:03-lowess-bwt-lwt
#+ATTR_HTML: :width 640px
#+ATTR_ORG:  :width 100
[[./fig-03-lowess-bwt-lwt.png]]

La corrélation entre ces deux variables s'obtient grâce à [[stata:correlate][correlate]]. Notons que cette commande fonctionne avec deux variables ou une liste de variables de sorte qu'elle pourra également être utilisée pour construire une matrice de corrélation :

#+BEGIN_SRC stata :session :results output :exports both
summarize bwt lwt
correlate bwt lwt
#+END_SRC

Voici une formulation simplifiée du modèle de régression linéaire. Soit $y_i$ la réponse observée sur l'individu $i$, et $x_i$ sa valeur
observée pour le prédicteur $x$. Le modèle de régression linéaire s'écrit :
$$y_i = \beta_0+\beta_1x_i+\varepsilon_i,$$
où $\beta_0$ représente l'ordonnée à l'origine (/intercept/) et $\beta_1$ la pente (\emph{slope}) de la droite de régression, et
$\varepsilon_i\sim\mathcal{N}(0,\sigma^2)$ est un terme d'erreur (résidus, supposés indépendants). En minimisant les différences quadratiques entre les valeurs observées et les valeurs prédites (principe des MCO), on peut estimer les coefficients de régression, $\widehat\beta_0$ et $\widehat\beta_1$ :
$$\begin{array}{l}
\widehat\beta_0 = \bar y - \widehat\beta_1\bar x\\
\widehat\beta_1 = \sum(y_i-\bar y)(x_i-\bar x)/\sum(x_i-\bar x)^2\\
\end{array}$$

Sous $H_0$, le rapport entre l'estimé de la pente ($\widehat\beta_1$, de variance $\frac{\text{SSR}/(n-2)}{(n-1)s_x^2}$) et son erreur standard suit une loi de Student à $(n-2)$ degrés de liberté.

Les paramètres d'un tel modèle de régression, $\widehat\beta_0$ et $\widehat\beta_1$, peuvent être estimés grâce à la commande [[stata:regress][regress]], en indiquant la variable à prédire et la ou les variables explicatives. Pour un modèle de régression linéaire simple, on se retrouve donc avec l'expression la plus simple qui soit :

#+BEGIN_SRC stata :session :results output :exports both
regress bwt lwt
#+END_SRC

Les résultats fournis par [[stata:regress][regress]] se composent de deux tableaux : le tableau d'analyse de variance du modèle de régression, qui peut être supprimé via l'option =noheader=, et le tableau des coefficients de régression. La ligne =_cons= désigne le terme d'ordonnée à l'origine, $\widehat\beta_0$. Le résultat du test de Student associé à =lwt= ($\widehat\beta_1$) peut se retrouver manuellement une fois que l'on a extrait les valeurs d'intérêt :

#+BEGIN_SRC stata :session :results output :exports both
local tstat = _b[lwt] / _se[lwt]
display "t = " %4.2f `tstat' " p = " %4.3f 2*ttail(187, `tstat')
#+END_SRC
 
** Diagnostic du modèle

La commande [[stata:predict][predict]] permet non seulement de calculer les valeurs ajustées du modèle mais également les résidus du modèle ($\tilde y_i - y_i$) ainsi que d'autres statistiques utiles pour diagnostiquer la qualité d'ajustement du modèle de régression. 

#+BEGIN_SRC stata :session :results output :exports both
predict double yhat
predict double rs, rstudent
summarize rs
#+END_SRC

Un histogramme ou une courbe de densité permet de visualiser rapidement la forme de distribution des résidus. Voici un exemple avec [[stata:kdensity][kdensity]], pour lequel une courbe de desnité normale a été ajoutée à l'aide de l'option =normal= :

#+BEGIN_SRC stata :session :results output :exports code
kdensity rs, normal normopts(lpat(--))
graph export "fig-03-kdensity-rs.pdf", fontface(DroidSans) replace
#+END_SRC

#+CAPTION:   Distribution des résidus studentisés
#+NAME:      fig:03-kdensity-rs
#+LABEL:     fig:03-kdensity-rs
#+ATTR_HTML: :width 640px
#+ATTR_ORG:  :width 100
[[./fig-03-kdensity-rs.png]]

Le graphique suivant est plus informatif car il renseigne à la fois sur la distribution des résidus et la corrélation entre les valeurs prédites par le modèle et ces derniers, qui selon l'hypothèse du modèle doit être nulle. Ici, on utilise les valeurs de post-estimation calculées plus haut, mais il serait tout à fait possible d'utiliser directement la commande de post-estimation [[stata:rvfplot][rvfplot]] (ou [[stata:rvpplot][rvpplot]], mais dans le cas d'une régression avec un seul prédicteur cela ne change rien) :

#+BEGIN_SRC stata :session :results output :exports code
graph twoway scatter rs yhat, yline(0)
graph export "fig-03-scatter-rs-yhat.pdf", fontface(DroidSans) replace
#+END_SRC

#+CAPTION:   Relation entre valeurs ajustées et résidus
#+NAME:      fig:03-scatter-rs-yhat
#+LABEL:     fig:03-scatter-rs-yhat
#+ATTR_HTML: :width 640px
#+ATTR_ORG:  :width 100
[[./fig-03-scatter-rs-yhat.png]]

** Cas de la régression sur une variable catégorielle

On a vu dans le chapitre sur la [[./01-data.html][gestion des données]] comment représenter les variables catégorielles sous Stata : dans le cas des variables binaires, un codage sous forme de 0 et de 1 est parfaitement adéquat, tandis que dans le cas des variables à plus de deux modalités, on assigne à chaque niveau un code numérique en débutant à 1. Ainsi, pour une variable à trois modalités, le premier niveau sera représenté par la valeur 1 tandis que le troisième et dernier niveau prendra la valeur 3. On associera éventuellement des étiquettes à chacun des niveaux afin de mieux identifier les différentes classes.

Considérons la variable =smoke= qui indique si la mère fumait pendant le premier trimestre de sa grossesse :

#+BEGIN_SRC stata :session :results output :exports both
tabulate smoke, nolabel
tabstat bwt, by(smoke) stat(mean sd n)
#+END_SRC


#+BEGIN_SRC stata :session :results output :exports code
graph box bwt, over(smoke)
graph export "fig-03-box-bwt-smoke.pdf", fontface(DroidSans) replace
#+END_SRC

#+CAPTION:   Relation entre poids des bébés et statut fumeur
#+NAME:      fig:03-box-bwt-smoke
#+LABEL:     fig:03-box-bwt-smoke
#+ATTR_HTML: :width 640px
#+ATTR_ORG:  :width 100
[[./fig-03-box-bwt-smoke.png]]

Le modèle de régression suivant considère la variable =smoke= comme une variable numérique et le coefficient de régression pour cette variable représente la variation de poids lorsque =smoke= varie d'une unité (de 0 à 1, précisément) :

#+BEGIN_SRC stata :session :results output :exports both
regress bwt smoke
#+END_SRC

En indiquant à Stata que la variable =smoke= doit être traitée comme une variable catégorielle et de générer l'ensemble de variables indicatrices correspondant, on obtiendra strictement le même résultat du fait du codage initial en 0/1 :

#+BEGIN_SRC stata :session :results output :exports both
regress bwt i.smoke
#+END_SRC







** Lien avec le test de Student

#+BEGIN_SRC stata :session :results output :exports both
ttest bwt, by(smoke)
#+END_SRC



** Traitement de la non linéarité


* La régression linéaire multiple

** Exemple de base

** Diagnostic du modèle

** Tests joints et intervalles de confiance simultanés

** Spécification de contrastes

** Comparaison de modèles emboîtés


* Modèle linéaire et applications

* Le modèle de régression logistique

#+BIBLIOGRAPHY: references nil limit:t option:-nobibsource

